

services:
  zabbix-server:
    image: zabbix/zabbix-appliance:alpine-latest
    container_name: zabbix-server
    mem_limit: 512m
    cpus: 1.0
    volumes:
      - zabbix-db:/var/lib/mysql
    ports:
      - "8080:80"   # Web UI
      - "10051:10051" # Zabbix Server
    networks:
      - monitoring-network
    restart: unless-stopped
    entrypoint: >
      sh -c "apk add --no-cache net-snmp net-snmp-tools &&
             echo 'Ferramentas SNMP instaladas no Zabbix Server' &&
             echo 'Testando conectividade SNMP com containers monitorados...' &&
             sleep 5 &&
             (snmpwalk -v2c -c public nginx-web:161 system 2>/dev/null && echo '✓ nginx-web respondendo via SNMP' || echo '✗ nginx-web não respondeu') &
             (snmpwalk -v2c -c public python-app:161 system 2>/dev/null && echo '✓ python-app respondendo via SNMP' || echo '✗ python-app não respondeu') &
             (snmpwalk -v2c -c public alpine-host:161 system 2>/dev/null && echo '✓ alpine-host respondendo via SNMP' || echo '✗ alpine-host não respondeu') &
             /sbin/tini -- /usr/bin/docker-entrypoint.sh"

  snmp-collector:
    build:
      context: ./snmp-collector
      dockerfile: Dockerfile
    container_name: snmp-collector
    mem_limit: 128m
    cpus: 0.5
    volumes:
      - snmp-data:/data
    ports:
      - "8090:8090"  # API REST
    networks:
      - monitoring-network
    restart: unless-stopped
    depends_on:
      - nginx-web
      - python-app
      - alpine-host

  nginx-web:
    image: nginx:alpine
    container_name: nginx-web
    mem_limit: 128m
    cpus: 0.5
    volumes:
      - ./monitored-services/nginx/html:/usr/share/nginx/html:ro
      - ./monitored-services/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "8081:80"
      - "16101:161/udp"  # SNMP
    networks:
      - monitoring-network
    restart: unless-stopped
    command: >
      sh -c "apk add --no-cache zabbix-agent2 net-snmp net-snmp-tools && 
             sed -i 's/Server=127.0.0.1/Server=zabbix-server/g' /etc/zabbix/zabbix_agent2.conf &&
             sed -i 's/ServerActive=127.0.0.1/ServerActive=zabbix-server/g' /etc/zabbix/zabbix_agent2.conf &&
             sed -i 's/Hostname=Zabbix server/Hostname=nginx-web/g' /etc/zabbix/zabbix_agent2.conf &&
             mkdir -p /etc/snmp /var/net-snmp &&
             echo 'rocommunity public' > /etc/snmp/snmpd.conf &&
             echo 'agentaddress udp:161' >> /etc/snmp/snmpd.conf &&
             echo 'sysLocation nginx-web-container' >> /etc/snmp/snmpd.conf &&
             echo 'sysContact admin@fcaps.local' >> /etc/snmp/snmpd.conf &&
             /usr/sbin/zabbix_agent2 -c /etc/zabbix/zabbix_agent2.conf &
             /usr/sbin/snmpd -Lsd -Lf /dev/null -p /var/run/snmpd.pid &
             sleep 2 &&
             nginx -g 'daemon off;'"

  python-app:
    build:
      context: ./monitored-services/python-app
      dockerfile: Dockerfile
    container_name: python-app
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - ./monitored-services/python-app/data:/app/data
    ports:
      - "5000:5000"
      - "16102:161/udp"  # SNMP
    networks:
      - monitoring-network
    restart: unless-stopped
    command: >
      sh -c "apk add --no-cache zabbix-agent2 net-snmp net-snmp-tools &&
             sed -i 's/Server=127.0.0.1/Server=zabbix-server/g' /etc/zabbix/zabbix_agent2.conf &&
             sed -i 's/ServerActive=127.0.0.1/ServerActive=zabbix-server/g' /etc/zabbix/zabbix_agent2.conf &&
             sed -i 's/Hostname=Zabbix server/Hostname=python-app/g' /etc/zabbix/zabbix_agent2.conf &&
             mkdir -p /etc/snmp /var/net-snmp &&
             echo 'rocommunity public' > /etc/snmp/snmpd.conf &&
             echo 'agentaddress udp:161' >> /etc/snmp/snmpd.conf &&
             echo 'sysLocation python-app-container' >> /etc/snmp/snmpd.conf &&
             echo 'sysContact admin@fcaps.local' >> /etc/snmp/snmpd.conf &&
             /usr/sbin/zabbix_agent2 -c /etc/zabbix/zabbix_agent2.conf &
             /usr/sbin/snmpd -Lsd -Lf /dev/null -p /var/run/snmpd.pid &
             sleep 2 &&
             python app.py"

  alpine-host:
    image: alpine:latest
    container_name: alpine-host
    mem_limit: 128m
    cpus: 0.5
    ports:
      - "16103:161/udp"  # SNMP
    command: >
      sh -c "apk add --no-cache sqlite zabbix-agent2 net-snmp net-snmp-tools &&
             sed -i 's/Server=127.0.0.1/Server=zabbix-server/g' /etc/zabbix/zabbix_agent2.conf &&
             sed -i 's/ServerActive=127.0.0.1/ServerActive=zabbix-server/g' /etc/zabbix/zabbix_agent2.conf &&
             sed -i 's/Hostname=Zabbix server/Hostname=alpine-host/g' /etc/zabbix/zabbix_agent2.conf &&
             mkdir -p /etc/snmp /var/net-snmp &&
             echo 'rocommunity public' > /etc/snmp/snmpd.conf &&
             echo 'agentaddress udp:161' >> /etc/snmp/snmpd.conf &&
             echo 'sysLocation alpine-host-container' >> /etc/snmp/snmpd.conf &&
             echo 'sysContact admin@fcaps.local' >> /etc/snmp/snmpd.conf &&
             /usr/sbin/zabbix_agent2 -c /etc/zabbix/zabbix_agent2.conf &
             /usr/sbin/snmpd -Lsd -Lf /dev/null -p /var/run/snmpd.pid &
             sleep 2 &&
             tail -f /dev/null"
    networks:
      - monitoring-network
    restart: unless-stopped

networks:
  monitoring-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  zabbix-db:
  snmp-data:
