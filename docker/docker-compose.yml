

services:
  zabbix-server:
    image: zabbix/zabbix-appliance:alpine-latest
    container_name: zabbix-server
    mem_limit: 512m
    cpus: 1.0
    volumes:
      - zabbix-db:/var/lib/mysql
    ports:
      - "8080:80"   # Web UI
      - "10051:10051" # Zabbix Server
    networks:
      - monitoring-network
    restart: unless-stopped
    entrypoint: >
      sh -c "apk add --no-cache net-snmp net-snmp-tools &&
             echo 'Ferramentas SNMP instaladas no Zabbix Server' &&
             echo 'Testando conectividade SNMP com containers monitorados...' &&
             sleep 5 &&
             (snmpwalk -v2c -c public nginx-web:161 system 2>/dev/null && echo '✓ nginx-web respondendo via SNMP' || echo '✗ nginx-web não respondeu') &
             (snmpwalk -v2c -c public python-app:161 system 2>/dev/null && echo '✓ python-app respondendo via SNMP' || echo '✗ python-app não respondeu') &
             (snmpwalk -v2c -c public alpine-host:161 system 2>/dev/null && echo '✓ alpine-host respondendo via SNMP' || echo '✗ alpine-host não respondeu') &
             /sbin/tini -- /usr/bin/docker-entrypoint.sh"

  snmp-collector:
    build:
      context: ./snmp-collector
      dockerfile: Dockerfile
    container_name: snmp-collector
    mem_limit: 128m
    cpus: 0.5
    volumes:
      - snmp-data:/data
    ports:
      - "8090:8090"  # API REST
      - "16104:161/udp"  # SNMP
    networks:
      - monitoring-network
    restart: unless-stopped
    depends_on:
      - nginx-web
      - python-app
      - alpine-host

  nginx-web:
    build:
      context: ./monitored-services/nginx
      dockerfile: Dockerfile
    container_name: nginx-web
    mem_limit: 128m
    cpus: 0.5
    ports:
      - "8081:80"
      - "16101:161/udp"  # SNMP
    networks:
      - monitoring-network
    restart: unless-stopped

  python-app:
    build:
      context: ./monitored-services/python-app
      dockerfile: Dockerfile
    container_name: python-app
    mem_limit: 256m
    cpus: 0.5
    volumes:
      - ./monitored-services/python-app/data:/app/data
    ports:
      - "5000:5000"
      - "16102:161/udp"  # SNMP
    networks:
      - monitoring-network
    restart: unless-stopped

  alpine-host:
    build:
      context: ./monitored-services/alpine-host
      dockerfile: Dockerfile
    container_name: alpine-host
    mem_limit: 128m
    cpus: 0.5
    ports:
      - "16103:161/udp"  # SNMP
    networks:
      - monitoring-network
    restart: unless-stopped

networks:
  monitoring-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  zabbix-db:
  snmp-data:
